---
title: "YDSP collaboration p-tech"
author: "Kevin Kuehn"
date: "2/27/2020"
output: html_document
---

Loading packaages

```{r, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
library(psych)
library(ggplot2)
library(corrplot) #plotting correlation matrices
library(GPArotation) #methods for factor rotation
library(nFactors)  #methods for determining the number of factors
library(lavaan)  #for fitting structural equation models
library(semPlot)  #for automatically making diagrams 
library(foreign)
```

Reading in the data, converting data from matrix to a data frame

```{r}
data<-read.spss("~/Documents/Writing/YDSP collab/YDSP/Daily Diaries.sav")

data<-as.data.frame(data)
```

30 variables and 952 observations. 28 observations per person, 34 people (no ID 208 and 219)

```{r}
data$Self_Efficacy<-as.numeric(data$Self_Efficacy)
```

The following code de-trends the data by running either a linear or generalized linear model for each of the variables predicted by time and then extracting the residuals(

```{r}
data$Self_Efficacy<-as.numeric(data$Self_Efficacy)
mod1<-lm(Self_Efficacy~Day, data=data, na.action=na.exclude)
Self_Efficacy_resid<-as.numeric(residuals(mod1))

mod2<-lm(SI~Day, data=data, na.action=na.exclude)
SI_resid<-as.numeric(residuals(mod2))

mod3<-lm(SIfreq~Day, data=data, na.action=na.exclude)
SIfreq_resid<-as.numeric(residuals(mod3))

mod4<-lm(SIDur~Day, data=data, na.action=na.exclude)
SIDur_resid<-as.numeric(residuals(mod4))

mod5<-lm(SIUrge~Day, data=data, na.action=na.exclude)
SIUrge_resid<-as.numeric(residuals(mod5))

data$Happy<-as.numeric(data$Happy)
mod6<-lm(Happy~Day, data=data, na.action=na.exclude)
Happy_resid<-as.numeric(residuals(mod6))

data$Miserable<-as.numeric(data$Miserable)
mod7<-lm(Miserable~Day, data=data, na.action=na.exclude)
Miserable_resid<-as.numeric(residuals(mod7))

data$Angry<-as.numeric(data$Angry)
mod8<-lm(Angry~Day, data=data, na.action=na.exclude)
Angry_resid<-as.numeric(residuals(mod8))

data$SI_Coping_TalkFamily<-as.numeric(data$SI_Coping_TalkFamily)
mod9<-glm(SI_Coping_TalkFamily~Day, data=data, na.action=na.exclude)
SI_Coping_TalkFamily_resid<-as.numeric(residuals(mod9))

data$SI_Coping_TalkFriend<-as.numeric(data$SI_Coping_TalkFriend)
mod10<-glm(SI_Coping_TalkFriend~Day, data=data, na.action=na.exclude)
SI_Coping_TalkFriend_resid<-as.numeric(residuals(mod10))

data$SI_Coping_TalkMH<-as.numeric(data$SI_Coping_TalkMH)
mod11<-glm(SI_Coping_TalkMH~Day, data=data, na.action=na.exclude)
SI_Coping_TalkMH_resid<-as.numeric(residuals(mod11))

data$SI_Coping_CrisisLine<-as.numeric(data$SI_Coping_CrisisLine)
mod12<-glm(SI_Coping_CrisisLine~Day, data=data, na.action=na.exclude)
SI_Coping_CrisisLine_resid<-as.numeric(residuals(mod12))

data$SI_Coping_Distraction<-as.numeric(data$SI_Coping_Distraction)
mod13<-glm(SI_Coping_Distraction~Day, data=data, na.action=na.exclude)
SI_Coping_Distraction_resid<-as.numeric(residuals(mod13))

data$SI_Coping_Relaxation<-as.numeric(data$SI_Coping_Relaxation)
mod14<-glm(SI_Coping_Relaxation~Day, data=data, na.action=na.exclude)
SI_Coping_Relaxation_resid<-as.numeric(residuals(mod14))

data$SI_Coping_CopingThought<-as.numeric(data$SI_Coping_CopingThought)
mod15<-glm(SI_Coping_CopingThought~Day, data=data, na.action=na.exclude)
SI_Coping_CopingThought_resid<-as.numeric(residuals(mod15))

data$SI_Coping_ReasonsforLiving<-as.numeric(data$SI_Coping_ReasonsforLiving)
mod16<-glm(SI_Coping_ReasonsforLiving~Day, data=data, na.action=na.exclude)
SI_Coping_ReasonsforLiving_resid<-as.numeric(residuals(mod16))

data$SI_Coping_HowHelpful<-as.numeric(data$SI_Coping_HowHelpful)
mod17<-lm(SI_Coping_HowHelpful~Day, data=data, na.action=na.exclude)
SI_Coping_HowHelpful_resid<-as.numeric(residuals(mod17))

data$Feelings_Coping_TalkFriend<-as.numeric(data$Feelings_Coping_TalkFriend)
mod18<-glm(Feelings_Coping_TalkFriend~Day, data=data, na.action=na.exclude)
Feelings_Coping_TalkFriend_resid<-as.numeric(residuals(mod18))

data$Feelings_Coping_TalkMH<-as.numeric(data$Feelings_Coping_TalkMH)
mod19<-glm(Feelings_Coping_TalkMH~Day, data=data, na.action=na.exclude)
Feelings_Coping_TalkMH_resid<-as.numeric(residuals(mod19))

data$Feelings_Coping_CrisisLine<-as.numeric(data$Feelings_Coping_CrisisLine)
mod20<-glm(Feelings_Coping_CrisisLine~Day, data=data, na.action=na.exclude)
Feelings_Coping_CrisisLine_resid<-as.numeric(residuals(mod20))

data$Feelings_Coping_Distraction<-as.numeric(data$Feelings_Coping_Distraction)
mod21<-glm(Feelings_Coping_Distraction~Day, data=data, na.action=na.exclude)
Feelings_Coping_Distraction_resid<-as.numeric(residuals(mod21))

data$Feelings_Coping_Relaxation<-as.numeric(data$Feelings_Coping_Relaxation)
mod22<-glm(Feelings_Coping_Relaxation~Day, data=data, na.action=na.exclude)
Feelings_Coping_Relaxation_resid<-as.numeric(residuals(mod22))
                                             
data$Feelings_Coping_CopingThought<-as.numeric(data$Feelings_Coping_CopingThought)
mod23<-glm(Feelings_Coping_CopingThought~Day, data=data, na.action=na.exclude)
Feelings_Coping_CopingThought_resid<-as.numeric(residuals(mod23))

data$Feelings_Coping_ThinkDifferently<-as.numeric(data$Feelings_Coping_ThinkDifferently)
mod24<-glm(Feelings_Coping_ThinkDifferently~Day, data=data, na.action=na.exclude)
Feelings_Coping_ThinkDifferently_resid<-as.numeric(residuals(mod24))

data$Feelings_Coping_HowHelpful<-as.numeric(data$Feelings_Coping_HowHelpful)
mod25<-lm(Feelings_Coping_HowHelpful~Day, data=data, na.action=na.exclude)
Feelings_Coping_HowHelpful_resid<-as.numeric(residuals(mod25))
```

Create a new dataset with the de-trend variables, SI coping variables seems to be mutually exclusive with coping of feelings so produces NA in correlation matrix; leaving out. 

```{r}
data_detrend<-data.frame(cbind(data$ID, data$Day, data$week, Self_Efficacy_resid, SI_resid, SIfreq_resid, SIDur_resid, SIUrge_resid, Happy_resid, Miserable_resid, Angry_resid,  Feelings_Coping_TalkFriend_resid, Feelings_Coping_TalkMH_resid, Feelings_Coping_CrisisLine_resid, Feelings_Coping_Distraction_resid, Feelings_Coping_Relaxation_resid, Feelings_Coping_CopingThought_resid, Feelings_Coping_ThinkDifferently_resid, Feelings_Coping_HowHelpful_resid))

names(data_detrend)[names(data_detrend) == "V1"] <- "ID"
names(data_detrend)[names(data_detrend) == "V2"] <- "Day"
names(data_detrend)[names(data_detrend) == "V3"] <- "Week"
```

Split the data into individual data files based on ID

```{r}
pdat1 <- data_detrend[data_detrend$ID==201, ] 
pdat2 <- data_detrend[data_detrend$ID==202, ] 
pdat3 <- data_detrend[data_detrend$ID==203, ] 
pdat4 <- data_detrend[data_detrend$ID==204, ]
pdat5 <- data_detrend[data_detrend$ID==205, ] 
pdat6 <- data_detrend[data_detrend$ID==206, ]
pdat7 <- data_detrend[data_detrend$ID==207, ] 
pdat9 <- data_detrend[data_detrend$ID==209, ] 
pdat10 <- data_detrend[data_detrend$ID==210, ]
pdat11 <- data_detrend[data_detrend$ID==211, ] 
pdat12 <- data_detrend[data_detrend$ID==212, ] 
pdat13 <- data_detrend[data_detrend$ID==213, ] 
pdat14 <- data_detrend[data_detrend$ID==214, ]
pdat15 <- data_detrend[data_detrend$ID==215, ] 
pdat16 <- data_detrend[data_detrend$ID==216, ]
pdat17 <- data_detrend[data_detrend$ID==217, ] 
pdat18 <- data_detrend[data_detrend$ID==218, ]
pdat20 <- data_detrend[data_detrend$ID==220, ]
pdat21 <- data_detrend[data_detrend$ID==221, ] 
pdat22 <- data_detrend[data_detrend$ID==222, ] 
pdat23 <- data_detrend[data_detrend$ID==223, ] 
pdat24 <- data_detrend[data_detrend$ID==224, ]
pdat25 <- data_detrend[data_detrend$ID==225, ] 
pdat26 <- data_detrend[data_detrend$ID==226, ]
pdat27 <- data_detrend[data_detrend$ID==227, ] 
pdat28 <- data_detrend[data_detrend$ID==228, ]
pdat29 <- data_detrend[data_detrend$ID==229, ] 
pdat30 <- data_detrend[data_detrend$ID==230, ]
pdat31 <- data_detrend[data_detrend$ID==231, ] 
pdat32 <- data_detrend[data_detrend$ID==232, ] 
pdat33 <- data_detrend[data_detrend$ID==233, ] 
pdat34 <- data_detrend[data_detrend$ID==234, ]
pdat35 <- data_detrend[data_detrend$ID==235, ] 
pdat36 <- data_detrend[data_detrend$ID==236, ]
```

```{r}
head(pdat1, 1,10)
```

```{r}
describe(pdat1[,-1])
```

```{r}
round(cor(pdat1[,-1], use = "pairwise.complete.obs"),2)
```

```{r}
corrplot(cor(pdat1[,-1], use="pairwise.complete.obs"), order = "original", tl.col='black', tl.cex=.75)
```

```{r}
corpdat1 <- cor(pdat1[,-1], use="pairwise.complete.obs")
round(corpdat1,2)
```

```{r}
fa.parallel(x=corpdat1, fm="minres", fa="fa")
```

```{r}
nScree(x=corpdat1,model="factors")
```

```{r}
plot(nScree(x=corpdat1,model="factors"))
```

```{r}
EFApdat1_4factor <- fa(r = corpdat1, nfactors = 4, 
                       rotate = "oblimin", 
                       fm = "pa")
EFApdat1_4factor
```

```{r}
EFApdat1_3factor <- fa(r = pdat1[,-1], nfactors = 3, 
                       rotate = "oblimin", 
                       fm = "pa",
                       scores="regression")

head(EFApdat1_3factor$scores,10)
```

```{r}
pairs.panels(EFApdat1_4factor$scores)
```

```{r}
#remaking plot data 
pdat1_plot <- cbind(pdat1$ID,pdat1[,-1], EFApdat1_4factor$scores)
#Plotting factor scores
ggplot(data=pdat1_plot, aes(x=day)) +
  geom_line(aes(y=PA1), color= 1) + 
  geom_line(aes(y=PA2), color= 2) + 
  geom_line(aes(y=PA3), color= 3) + 
  geom_line(aes(y=PA4), color= 3) + 
  xlab("Day") + ylab("Factor Score") + 
  scale_x_continuous(limits=c(0,28)) +
  ggtitle("Person A: Latent Factor Time Series")
```

```{r}
EFApdat1_4factor$Vaccounted[3,3]
```

```{r}
round(EFApdat1_4factor$uniquenesses,3)
```

```{r}
round(EFApdat1_4factor$residual - diag(EFApdat1_4factor$uniquenesses),3) 
```